<!DOCTYPE html>
<html lang="en">
<head>
  <title>Pokedex Lookup Tool</title>
  <link rel="stylesheet" type="text/css" href="/style.css">
  
  <script>
    async function handleResponse(response) {
      const content = document.querySelector('#content');

      switch(response.status) {
        case 200:
          content.innerHTML = '<b>Success</b>'
          break;
        case 201:
          content.innerHTML = '<b>Created</b>'
          break;
        case 204:
          content.innerHTML = '<b>Updated (No Content)</b>'
          break;
        case 400:
          content.innerHTML = '<b>Bad Request</b>'
          break;
        case 404:
          content.innerHTML = '<b>Not Found</b>'
          break;
        default: 
          content.innerHTML = '<b>Status code not implemented by client</b>'
      }

      const responseObj = await response.json();
      if(responseObj.message) {
        content.innerHTML += `<p>${responseObj.message}</p>`
      }
      else {
        content.innerHTML += `<p>${JSON.stringify(responseObj.users)}</p>`
      }
      await updateTypes();
      await updateSelectionLimit();
    }

    async function sendPost (form, body) {
      const url = form.getAttribute('action');
      const method = form.getAttribute('method');

      const response = await fetch(url, {
        method,
        headers: {
          'Content-Type': 'application/json',
          'Content-Length': body.length,
          'Accept': 'application/json'
        },
        body
      });

      handleResponse(response)
    }

    //createPokemon
    //we're building the request body to send into sendPost
    async function createPokemon(form) {
      const name = form.querySelector('#postName').value;
      const imageLink = form.querySelector('#postImgLink').value;
      const type1 = form.querySelector('#postType1').value;
      const type2 = form.querySelector('#postType2').value;
      const height = form.querySelector('#postHeight').value;
      const weight = form.querySelector('#postWeight').value;

      const formData = JSON.stringify({name, imageLink, type1, type2, height, weight})

      sendPost(form, formData)
    }

    async function sendGet(form, query = '') {
      let url = form.action;
      const method = form.method;
      url += query;

      const response = await fetch(url, {
        method,
        headers: {
          'Accept': 'application/json'
        }
      })
      handleResponse(response)
    }

    async function getAll(form){
      await sendGet(form);
    }
    async function getAllTypes(form){
      await sendGet(form);
    }

    async function getByName(form) {
      const name = form.querySelector('#name').value;
      let query = `?name=${name}`

      await sendGet(form, query)
    }

    async function getByType(form) {
      //so what we want to do is
      //take out all the types we selected, and build the query with them
      const allSelectedTypes = form.querySelectorAll('input[name=type]:checked')

      let query = "?types=" //the beginning of every query
      allSelectedTypes.forEach(type => {
        console.log(type)
        query += `${type.value},`;
        //comma separated list in a query... 
        //only doing this bc gets can't have a request body and i want to be able to select multiple types at once
        //this specific implementation leaves a blank item at the end once i split it but it's fine
      })

      await sendGet(form, query);
    }

    async function getByDexNumber(form) {
      const num = form.querySelector('#number').value;
      let query = `?dexNumber=${num}`

      await sendGet(form, query)
    }

    function formSetup(formId, formFunction){
      const form = document.querySelector(formId);
      
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        formFunction(form);
        return false;
      })
    }

    async function createType(form) {
      const name = form.querySelector('#typeName').value;
      const weak = form.querySelector('#typeWeak');
      const res = form.querySelector('#typeRes');
      const immune = form.querySelector('#typeImmune');

      //create an array from the collection, and only get the values from em
      const weaknesses = Array.from(weak.querySelectorAll('input[name=type]:checked')).map(t => t.value);
      const resistances = Array.from(res.querySelectorAll('input[name=type]:checked')).map(t => t.value);
      const immunities = Array.from(immune.querySelectorAll('input[name=type]:checked')).map(t => t.value);

      const formData = JSON.stringify({name, weaknesses, resistances, immunities})

      await sendPost(form, formData);
    }

    async function changeType(form) {
      const name = form.querySelector('#typeName').value;
      const type1 = form.querySelector('#type1').value;
      const type2 = form.querySelector('#type2').value;

      const formData = JSON.stringify({name, type1, type2});

      await sendPost(form, formData)
    }

    //using this to update the type displays as the types array is updated via createType
    //handleResponse as well as init will use this to populate the form elements when types are updated
    async function updateTypes() {

      //we get the types response
      const response = await fetch('/getAllTypes', {
        method: "GET",
        headers: {
          "Accept": "/application/json"
        }
      });
      const allTypes = await response.json();
      
      //we get the forms themselves
      const createTypeForm = document.querySelector('#createTypeForm');
      const getTypeForm = document.querySelector('#getByTypeForm');

      //and the elements within them that hold the type options
      const weak = createTypeForm.querySelector('#typeWeak');
      const res = createTypeForm.querySelector('#typeRes');
      const immune = createTypeForm.querySelector('#typeImmune');
      const get = getTypeForm.querySelector('#getByType');

      //put em in an array, clear them (so it doesn't override anything)
      const typeHolders = [weak, res, immune, get]
      typeHolders.forEach(h => h.innerHTML = '');

      for(const t of allTypes){
        for(const h of typeHolders){
        const typeOption = document.createElement('input');
        typeOption.type = 'checkbox';
        typeOption.name = 'type';
        typeOption.value = t.name;
        typeOption.id = t.name;

        const label = document.createElement('label');
        label.innerText = t.name[0].toUpperCase() + t.name.substring(1);
        label.for = t.name;

        h.appendChild(typeOption);
        h.appendChild(label);
        }
      }
    }

    async function updateSelectionLimit() {
      const response = await fetch('/getAll', {
        method: "GET",
        headers: {
          "Accept": "/application/json"
        }
      });
      const allMons = await response.json();

      const dexNumLimit = document.querySelector('#number');
      dexNumLimit.max = allMons.length;
    } 

    function init() {
      updateTypes();
      formSetup("#getByNameForm", getByName);
      formSetup("#getAllForm", getAll);
      formSetup("#getByTypeForm", getByType);
      formSetup("#getByNumberForm", getByDexNumber);
      formSetup("#createMonForm", createPokemon);
      formSetup("#createTypeForm", createType);
      formSetup("#changeTypeForm", changeType);
      //i could do the same thing i did for the urls here and make an object that stores each of these
      //that might be a little more elegant
    }

    window.onload = init;
  </script>
</head>
<body>
  <section id="top">
    <h3>Pokedex Lookup Tool</h3>
    <div class="endpointBox">
      <h2 class="endpointHeader">Get All Pokemon</h2>
      <p>No parameters needed.</p>
      <form id="getAllForm" action="/getAll" method="get">
        <input type="submit" value="Submit"/>
      </form>
    </div>
    <div class="endpointBox">
      <h2 class="endpointHeader">Get Pokemon By Name</h2>
      <form id="getByNameForm" action="/getByName" method="get">
        <label for="getName">Name</label>
        <input type="text" name="name" id="name">
        <br>
        <input type="submit" value="Submit"/>
      </form>
    </div>
    <div class="endpointBox">
      <h2 class="endpointHeader">Get Pokemon By Type</h2>
      <form id="getByTypeForm" action="/getByType" method="get">
        <div id="getByType">

        </div>
        <input type="submit" value="Submit"/>
      </form>
    </div>
    <div class="endpointBox">
      <h2 class="endpointHeader">Get Pokemon By Pokedex Number</h2>
      <form id="getByNumberForm" action="/getByDexNumber" method="get">
        <label for="getNumber">Pokedex Number</label>
        <input type="number" name="number" id="number" min="1" max="151">
        <br>
        <input type="submit" value="Submit"/>
      </form>
    </div>
    <div class="endpointBox">
      <h2 class="endpointHeader">Create Pokemon</h2>
      <form id="createMonForm" action="/createPokemon" method="post">
        <label for="postName">Name</label>
        <input type="text" name="name" id="postName">
        <br>
        <label for="postImgLink">Image Link</label>
        <input type="url" name="imgLink" id="postImgLink">
        <br>
        <label for="postType1">Type 1</label>
        <input type="text" name="type1" id="postType1">
        <br>
        <label for="postType2">Type 2</label>
        <input type="text" name="type2" id="postType2">
        <br>
        <label for="postHeight">Height (m)</label>
        <input type="number" name="height" id="postHeight" step=".01">
        <br>
        <label for="postWeight">Weight (kg)</label>
        <input type="number" name="weight" id="postWeight" step=".01">
        <br>
        <input type="submit" value="Submit"/>
      </form>
    </div>
    <div class="endpointBox">
      <h2 class="endpointHeader">Create Type</h2>
      <form id="createTypeForm" action="/createType" method="post">
        <label for="typeName">Name</label>
        <input type="text" name="name" id="typeName">
        <br>
        <label for="typeWeak">Weaknesses</label>
        <br>
       <div id="typeWeak"></div>
        <br>
        <label for="typeRes">Resistances</label>
        <br>
       <div id="typeRes"></div>
        <br>
        <label for="typeImmune">Immunities</label>
        <br>
       <div id="typeImmune"></div>
        <br>
        <input type="submit" value="Submit"/>
      </form>
    </div>
    <div class="endpointBox">
      <h2 class="endpointHeader">Edit a Pokemon's Type</h2>
      <form id="changeTypeForm" action="/changeType" method="post">
        <label for="typeName">Name</label>
        <input type="text" name="name" id="typeName">
        <br>
        <label for="type1">Type 1</label>
        <input type="text" name="type1" id="type1">
        <br>
        <label for="type2">Type 2</label>
        <input type="text" name="type2" id="type2">
        <br>
        <input type="submit" value="Submit"/>
      </form>
    </div>
  </section>
  <section id="content">
  </section>
</body>
</html>
